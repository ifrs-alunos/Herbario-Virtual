{% extends 'dashboard/dashboard.html' %}
{% load crispy_forms_tags %}

{% block item %}
<div class="container-fluid">
    <div class="card" style="border-color: #2c6b3a;">
        <div class="card-header text-white" style="background-color: #2c6b3a;">
            <h5 class="card-title mb-0">
                <i class="fas fa-bell me-2"></i>Enviar Alerta Manual - Editor Completo
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" id="alertForm">
                {% csrf_token %}
                
                {% if messages %}
                <div class="messages mb-4">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="math_model" class="form-label">Modelo Matemático *</label>
                            <select name="math_model" id="math_model" class="form-control" required onchange="updateMessageTemplate()">
                                <option value="">Selecione um modelo</option>
                                {% for model in math_models %}
                                <option value="{{ model.id }}" data-message="{{ model.alert_message|default:'' }}">
                                    {{ model.name }} {% if model.disease %}- {{ model.disease.name_disease }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="station" class="form-label">Estação *</label>
                            <select name="station" id="station" class="form-control" required onchange="updateMessagePreview()">
                                <option value="">Selecione uma estação</option>
                                {% for station in stations %}
                                <option value="{{ station.id }}">{{ station.alias }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="value" class="form-label">Valor do Alerta</label>
                            <input type="number" name="value" id="value" class="form-control" step="0.01" value="0.15" onchange="updateMessagePreview()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="temperature" class="form-label">Temperatura (°C) - Opcional</label>
                            <input type="number" name="temperature" id="temperature" class="form-control" step="0.1" placeholder="Ex: 25.0" onchange="updateMessagePreview()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="humidity" class="form-label">Umidade (%) - Opcional</label>
                            <input type="number" name="humidity" id="humidity" class="form-control" step="0.1" placeholder="Ex: 80.0" onchange="updateMessagePreview()">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="message" class="form-label">Mensagem do Alerta *</label>
                    <textarea name="message" id="message" class="form-control" rows="6" required placeholder="Digite a mensagem de alerta completa..."></textarea>
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i> Variáveis disponíveis: 
                        <span class="badge bg-secondary" onclick="insertVariable('{value}')">{value}</span>
                        <span class="badge bg-secondary" onclick="insertVariable('{station}')">{station}</span>
                        <span class="badge bg-secondary" onclick="insertVariable('{disease}')">{disease}</span>
                        <span class="badge bg-secondary" onclick="insertVariable('{temp}')">{temp}</span>
                        <span class="badge bg-secondary" onclick="insertVariable('{humidity}')">{humidity}</span>
                        <span class="badge bg-secondary" onclick="insertVariable('{model}')">{model}</span>
                        <span class="badge bg-secondary" onclick="insertVariable('{rain}')">{rain}</span>
                        <br>
                        <em>Clique em uma variável para inserir na mensagem</em>
                    </small>
                </div>

                <!-- Opção para atualizar o modelo -->
                <div class="form-group form-check">
                    <input type="checkbox" name="update_math_model" id="update_math_model" class="form-check-input" checked>
                    <label class="form-check-label" for="update_math_model">
                        <strong>Atualizar mensagem padrão do Modelo Matemático</strong>
                    </label>
                    <small class="form-text text-muted">
                        Se marcado, a mensagem personalizada será salva como padrão no modelo matemático selecionado.
                    </small>
                </div>

                <!-- Preview da mensagem -->
                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-eye me-2"></i>Prévia da Mensagem (Telegram)
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="messagePreview" class="telegram-preview">
                            Selecione um modelo e estação para ver a prévia...
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-mobile-alt"></i> Esta é uma simulação de como a mensagem será exibida no Telegram.
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Atenção:</strong> Este alerta será enviado para todos os usuários cadastrados no Telegram.
                </div>
                
                <div class="form-group mt-4">
                    <button type="submit" class="btn text-white" style="background-color: #2c6b3a; border-color: #2c6b3a;">
                        <i class="fas fa-paper-plane"></i> Enviar Alerta Manual
                    </button>
                    <button type="button" class="btn btn-info" onclick="updateMessagePreview()">
                        <i class="fas fa-sync"></i> Atualizar Prévia
                    </button>
                    <a href="{% url 'dashboard:alert_history' %}" class="btn btn-secondary">
                        <i class="fa fa-times"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function insertVariable(variable) {
    const textarea = document.getElementById('message');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + variable + text.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + variable.length;
    textarea.focus();
    
    updateMessagePreview();
}

function updateMessageTemplate() {
    const mathModelSelect = document.getElementById('math_model');
    const messageTextarea = document.getElementById('message');
    const selectedOption = mathModelSelect.options[mathModelSelect.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const templateMessage = selectedOption.getAttribute('data-message');
        if (templateMessage && templateMessage.trim() !== '') {
            messageTextarea.value = templateMessage;
            updateMessagePreview();
        }
    }
}

function updateMessagePreview() {
    const mathModelSelect = document.getElementById('math_model');
    const stationSelect = document.getElementById('station');
    const valueInput = document.getElementById('value');
    const tempInput = document.getElementById('temperature');
    const humidityInput = document.getElementById('humidity');
    const messageTextarea = document.getElementById('message');
    const previewDiv = document.getElementById('messagePreview');
    
    const selectedModel = mathModelSelect.options[mathModelSelect.selectedIndex];
    const selectedStation = stationSelect.options[stationSelect.selectedIndex];
    
    if (!selectedModel.value || !selectedStation.value) {
        previewDiv.innerHTML = '<em>Selecione um modelo e estação para ver a prévia...</em>';
        return;
    }
    
    // Dados para substituição
    const data = {
        value: parseFloat(valueInput.value) || 0.15,
        station: selectedStation.text,
        disease: selectedModel.text.includes('-') ? selectedModel.text.split('-')[1].trim() : 'Doença',
        temp: tempInput.value ? parseFloat(tempInput.value).toFixed(1) + '°C' : 'N/A',
        humidity: humidityInput.value ? parseFloat(humidityInput.value).toFixed(1) + '%' : 'N/A',
        model: selectedModel.text.split('-')[0].trim(),
        rain: '0.0mm'
    };
    
    let message = messageTextarea.value;
    
    if (!message.trim()) {
        previewDiv.innerHTML = '<em class="text-muted">Digite uma mensagem para ver a prévia...</em>';
        return;
    }
    
    // Aplica as substituições de forma segura
    message = message
        .replace(/{value}/g, data.value.toFixed(3))
        .replace(/{station}/g, data.station)
        .replace(/{disease}/g, data.disease)
        .replace(/{temp}/g, data.temp)
        .replace(/{t}/g, data.temp)
        .replace(/{humidity}/g, data.humidity)
        .replace(/{rh}/g, data.humidity)
        .replace(/{rain}/g, data.rain)
        .replace(/{model}/g, data.model);
    
    previewDiv.innerHTML = message;
}

// Inicializar ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    updateMessagePreview();
});
</script>

<style>
.badge {
    font-size: 0.75em;
    margin: 2px;
    cursor: pointer;
    transition: all 0.2s;
}

.badge:hover {
    transform: scale(1.05);
    opacity: 0.9;
}

.telegram-preview {
    background-color: #f8f9fa;
    border-left: 4px solid #2c6b3a;
    font-size: 0.9em;
    line-height: 1.4;
    white-space: pre-wrap;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 15px;
    border-radius: 4px;
    min-height: 100px;
}

.form-text code {
    background-color: #e9ecef;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.85em;
    color: #2c6b3a;
}
</style>
{% endblock %}